<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organograma Fabreck (Funcional)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <style>
        /* Estilos gerais e de componentes */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        .employee-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transform: translateY(-2px);
            transition: all 0.2s ease-in-out;
        }

        /* Estilo para funcionários marcados como desligados */
        .employee-card.terminated {
            color: #b91c1c; /* Vermelho mais escuro */
            font-weight: 600;
            background-color: #fee2e2;
            text-decoration: line-through;
            opacity: 0.7;
        }
        
        .sub-nav-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
            border-bottom: 2px solid #e2e8f0;
        }

        .sub-nav-tabs button {
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            font-weight: 600;
            color: #64748b;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease-in-out;
            background-color: transparent;
            border-radius: 0.5rem 0.5rem 0 0;
            margin: 0 0.25rem;
        }

        .sub-nav-tabs button.active {
            color: #1e3a8a; /* Azul mais escuro */
            border-bottom-color: #1e3a8a;
            background-color: #ffffff;
        }

        .sub-nav-tabs button:hover:not(.active) {
            color: #2563eb;
            background-color: #eff6ff;
        }

        .sector-card {
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
            border-top: 4px solid #2563eb; /* Destaque azul */
            border-radius: 0.75rem;
            padding: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }

        .sector-card.leader {
            border-top-color: #c2410c; /* Destaque laranja para líderes */
        }

        .sector-card h4 {
            font-weight: 700;
            color: #111827;
            text-align: center;
            margin-bottom: 0.75rem;
            font-size: 1.125rem;
        }
        
        #sync-status.synced { color: #16a34a; }
        #sync-status.syncing { color: #f59e0b; animation: pulse 1.5s infinite; }
        #sync-status.error { color: #dc2626; }
        #sync-status.dirty { color: #ca8a04; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }


        /* --- Estilos de Impressão --- */
        @media print {
            body {
                background: #fff !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            nav,
            #modal-backdrop,
            #confirm-modal-backdrop,
            #message-container,
            .no-print {
                display: none !important;
            }

            .print-header {
                display: block !important;
                text-align: center;
                margin-bottom: 2rem;
            }
            
            .print-logo {
                width: 200px;
                height: auto;
                margin: 0 auto 1rem;
            }

            #print-footer {
                display: block !important;
                position: fixed;
                bottom: 0;
                left: 0;
                width: 100%;
                text-align: center;
                padding: 10px 0;
                font-size: 9pt;
                color: #666;
                border-top: 1px solid #ccc;
            }

            main {
                padding: 1cm !important;
                margin: 0 !important;
                width: 100% !important;
                max-width: 100% !important;
            }

            .printable-area {
                box-shadow: none !important;
                padding: 0 !important;
                border: none !important;
            }

            .print-title {
                display: block !important;
                text-align: center;
                font-size: 22pt;
                font-weight: bold;
                margin-bottom: 1.5rem;
            }

            .org-chart-container,
            .org-chart-columns {
                display: block !important;
                flex-direction: column !important;
            }

            .org-chart-column {
                width: 100% !important;
                page-break-inside: avoid;
                margin-bottom: 1.5cm;
            }

            .shift-header {
                background-color: #1e3a8a !important;
                color: white !important;
                padding: 0.5rem;
                border-radius: 0.5rem;
                text-align: center;
            }

            .shift-header h3 {
                font-size: 16pt;
                font-weight: bold;
            }

            .shift-header p {
                font-size: 10pt;
            }

            .sector-card {
                page-break-inside: avoid;
                border: 1px solid #ccc !important;
                margin-top: 1rem;
                box-shadow: none !important;
            }
            
            .sector-card.leader {
                border-top-color: #c2410c !important;
            }

            .sector-card h4 {
                font-size: 12pt;
                background-color: #f3f4f6 !important;
                padding: 0.25rem;
                border-radius: 0.25rem;
            }

            .employee-card {
                padding: 0.25rem;
                border: 1px solid #eee;
                background-color: #fff !important;
                font-size: 10pt;
                box-shadow: none !important;
            }

            .employee-card.terminated {
                color: #b91c1c !important;
                background-color: #fee2e2 !important;
            }
        }
    </style>
</head>

<body class="min-h-screen bg-gray-100 flex flex-col lg:flex-row">

    <!-- Barra de Navegação Lateral -->
    <nav class="bg-blue-900 text-white w-full lg:w-64 p-4 lg:p-6 shadow-lg flex flex-col flex-shrink-0 no-print">
        <div id="logo-container" class="mb-6 text-white"></div>
        <div id="navigation-container">
            <!-- O conteúdo da navegação será renderizado aqui pelo JavaScript -->
        </div>
        <div class="mt-auto pt-4 border-t border-blue-700">
            <h2 class="text-xl font-semibold mb-4 border-b border-blue-700 pb-2">Área Administrativa</h2>
            <div id="admin-login-section" class="hidden">
                <input type="password" id="admin-password-input" placeholder="Senha Admin"
                    class="w-full p-2 rounded-md bg-blue-800 text-white placeholder-blue-300 focus:outline-none focus:ring-2 focus:ring-blue-400 mb-2">
                <button id="admin-login-btn"
                    class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md transition duration-200 ease-in-out">Login
                    Admin</button>
            </div>
            <div id="admin-logout-section" class="hidden">
                <p class="text-sm mb-2">Logado como Admin.</p>
                 <div class="text-center my-2">
                    <span id="sync-status" class="text-xs font-semibold"></span>
                </div>
                <button id="save-cloud-btn"
                    class="w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-md transition duration-200 ease-in-out mb-4">Salvar Agora</button>
                <button id="admin-logout-btn"
                    class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md">Sair
                    Admin</button>
            </div>
        </div>
    </nav>

    <!-- Conteúdo Principal -->
    <main id="main-content-area" class="flex-grow p-4 sm:p-8 lg:p-10 flex items-center justify-center">
        <!-- O conteúdo principal será renderizado aqui pelo JavaScript -->
    </main>

    <!-- Contentores para Mensagens e Modais -->
    <div id="message-container" class="fixed bottom-4 right-4 z-[100]"></div>

    <div id="modal-backdrop"
        class="fixed inset-0 bg-gray-900 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-[60] hidden">
        <div id="modal-content" class="relative p-6 bg-white w-11/12 md:max-w-lg mx-auto rounded-xl shadow-lg">
            <div class="flex justify-between items-center pb-3 border-b">
                <h3 id="modal-title" class="text-xl font-semibold text-gray-900"></h3>
                <button id="modal-close-btn"
                    class="text-gray-400 hover:text-gray-600 text-2xl leading-none font-semibold">×</button>
            </div>
            <div id="modal-body" class="mt-4 max-h-[70vh] overflow-y-auto"></div>
        </div>
    </div>

    <div id="confirm-modal-backdrop"
        class="fixed inset-0 bg-gray-900 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-[70] hidden">
        <div class="relative p-6 bg-white w-11/12 md:max-w-sm mx-auto rounded-xl shadow-lg">
            <div class="flex justify-between items-center pb-3 border-b">
                <h3 id="confirm-modal-title" class="text-xl font-semibold text-gray-900">Confirmação</h3>
                <button id="confirm-modal-close-btn"
                    class="text-gray-400 hover:text-gray-600 text-2xl leading-none font-semibold">×</button>
            </div>
            <div class="mt-4">
                <p id="confirm-modal-message" class="text-gray-700 mb-6"></p>
                <div class="flex justify-end space-x-4">
                    <button id="confirm-modal-cancel-btn"
                        class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition">Cancelar</button>
                    <button id="confirm-modal-ok-btn"
                        class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="print-footer" class="hidden">
        PCP FABRECK . JENILTON CRUZ / ORGANOGRAMA
    </div>
    
    <script type="module">
        // Importações do Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Dados Iniciais (Este bloco será atualizado no download) ---
        const initialFactoriesData = {
            "pneus": {
                "id": "pneus",
                "name": "Organograma Pneus",
                "shifts": [{
                    "id": "morning-shift",
                    "name": "TURNO DA MANHÃ",
                    "time": "06:00-15:45 e 07:30-17:15",
                    "responsible": "Jacaré",
                    "functions": {
                        "CALDEIRA": [{ "id": "francisco", "name": "FRANCISCO", "status": "active" }],
                        "CORTE CAMELBACK": [{ "id": "cristhian", "name": "CRISTHian", "status": "active" }],
                        "PINTURA": [{ "id": "gabriel", "name": "GABRIEL", "status": "active" }],
                        "CORTE DE LONA": [
                            { "id": "angelica", "name": "ANGELICA", "status": "active" },
                            { "id": "rebeca", "name": "REBECA", "status": "active" },
                            { "id": "antonia", "name": "ANTONIA", "status": "active" }
                        ],
                        "CONSTRUÇÃO": [
                            { "id": "gustavo", "name": "GUSTAVO", "status": "active" },
                            { "id": "miriam", "name": "MIRIAM", "status": "active" },
                            { "id": "vanderleia", "name": "VANDERLEIA", "status": "active" }
                        ],
                        "REBARBA E INSPEÇÃO": [
                            { "id": "poliane-m", "name": "POLIANE", "status": "active" },
                            { "id": "eduarda", "name": "EDUARDA", "status": "active" }
                        ],
                        "OPERADOR EMPILHADEIRA": [{ "id": "roberto-kobayashi", "name": "ROBERTO KOBAYASHI", "status": "active" }],
                        "VULCANIZAÇÃO": [{ "id": "pedro-toneli", "name": "PEDRO TONELI", "status": "active" }],
                        "MANUTENÇÃO": []
                    }
                }, {
                    "id": "afternoon-shift",
                    "name": "TURNO DA TARDE",
                    "time": "13:00-22:45",
                    "responsible": "Brendo",
                    "functions": {
                        "CALDEIRA": [{ "id": "tales", "name": "TARLES PEREIRA CABRAL", "status": "active" }],
                        "CORTE CAMELBACK": [{ "id": "maicon", "name": "MAICON", "status": "active" }],
                        "PINTURA": [{ "id": "eliel", "name": "ELIEL LEITE BARBOSA", "status": "active" }],
                        "CORTE DE LONA": [{ "id": "vanessa", "name": "VANESSA", "status": "active" }],
                        "CONSTRUÇÃO": [
                            { "id": "franklin", "name": "FRANKLIN JUNIOR DOS SANTOS ARAUJO", "status": "active" },
                            { "id": "matheus", "name": "MATHEUS MAURICIO", "status": "active" },
                            { "id": "yuri", "name": "IURI GOBES", "status": "active" }
                        ],
                        "TALÃO": [{ "id": "rian", "name": "RYAN MELLO VIANA", "status": "active" }],
                        "REBARBA E INSPEÇÃO": [{ "id": "poliane-t", "name": "POLIANE", "status": "active" }],
                        "VULCANIZAÇÃO": [{ "id": "kaique", "name": "KAIQUE", "status": "active" }],
                        "MANUTENÇÃO": []
                    }
                }, {
                    "id": "night-shift",
                    "name": "TURNO DA NOITE",
                    "time": "22:00-06:00",
                    "responsible": "Válber",
                    "functions": {
                        "CALDEIRA": [{ "id": "thiago-de-mello", "name": "THIAGO DE MELLO", "status": "active" }],
                        "CORTE CAMELBACK": [{ "id": "juvenal-neto", "name": "JUVENAL NETO", "status": "active" }],
                        "CONSTRUÇÃO": [{ "id": "thiago-marreta", "name": "THIAGO MARRETA", "status": "active" }],
                        "TALÃO": [{ "id": "laercio-moreira-junior", "name": "LAÉRCIO MOREIRA JUNIOR", "status": "active" }],
                        "REBARBA E INSPEÇÃO": [{ "id": "eliane", "name": "ELIANE", "status": "active" }],
                        "VULCANIZAÇÃO": [
                            { "id": "pedro-henrique-silvestre", "name": "PEDRO HENRIQUE SILVESTRE", "status": "active" },
                            { "id": "eduardo", "name": "EDUARDO", "status": "active" }
                        ],
                        "MANUTENÇÃO": []
                    }
                }]
            },
            "bAro": {
                "id": "bAro",
                "name": "Organograma B-Aro",
                "sectors": {
                    "LIXADEIRAS": [
                        { "id": "emp-1756380093840", "name": "GUILHERME NOVATO", "status": "active" },
                        { "id": "emp-baro-6", "name": "JOÃO VICTOR DOS SANTOS", "status": "active" },
                        { "id": "emp-baro-7", "name": "PEDRO AUGUSTO DOS SANTOS", "status": "active" },
                        { "id": "emp-baro-8", "name": "TIAGO LUCAS DE MELO", "status": "active" }
                    ],
                    "POLIMENTO DE FERRO E ALUMÍNIO": [
                        { "id": "emp-baro-13", "name": "DENER MELO", "status": "active" },
                        { "id": "emp-baro-14", "name": "OSCAR ESCALONA MACHADO", "status": "active" },
                        { "id": "emp-baro-15", "name": "MARCOS VINICIUS BITENCOURT", "status": "active" }
                    ],
                    "LÍDERES DE PRODUÇÃO": [
                        { "id": "emp-baro-22", "name": "XANDECO", "status": "active" },
                        { "id": "emp-baro-24", "name": "LEONARDO", "status": "active" },
                        { "id": "emp-baro-23", "name": "BOMBADO", "status": "active" }
                    ],
                    "FURAÇÃO": [
                        { "id": "emp-baro-16", "name": "WELLINGTON DE SOUZA", "status": "active" },
                        { "id": "emp-baro-17", "name": "LUCAS GEAN ALVES", "status": "active" }
                    ],
                    "FURAÇÃO BROCA": [{ "id": "emp-baro-18", "name": "OSMAR ALFONSO GONZALEZ", "status": "active" }],
                    "GUIDOM": [
                        { "id": "emp-baro-19", "name": "ADILSON MORAES DOS SANTOS", "status": "active" },
                        { "id": "emp-baro-20", "name": "DYONATHAM WILLIAM OLIVEIRA", "status": "active" }
                    ],
                    "ESMERIL DESBASTE": [{ "id": "emp-baro-12", "name": "MAICON VINÍCIUS ALVES RODRIGUES", "status": "active" }],
                    "ESMERIL EXTERNO": [{ "id": "emp-baro-11", "name": "CRISTIAN RAFAEL VALLINA", "status": "active" }],
                    "ESMERIL INTERNO": [{ "id": "emp-baro-10", "name": "FRANK DE JESUS SANDOVAL", "status": "active" }],
                    "CALANDRA E SERRA DE PERFIL ALUMÍNIO": [{ "id": "emp-baro-21", "name": "LEANDRO DE MELO", "status": "active" }],
                    "CALANDRA E SOLDA": [
                        { "id": "emp-baro-1", "name": "CÉLIO ROBERTO OLIVEIRA TONASSI", "status": "active" },
                        { "id": "emp-baro-3", "name": "PEDRO HENRIQUE DOS SANTOS", "status": "active" },
                        { "id": "emp-baro-2", "name": "DOUGLAS WAGNER BARBOZA", "status": "active" }
                    ],
                    "CONFORMADORA": [{ "id": "emp-baro-9", "name": "GUILHERME HENRIQUE LEITE XAVIER", "status": "active" }],
                    "SERRA": [
                        { "id": "emp-baro-4", "name": "THIAGO APARECIDO DE SOUZA", "status": "active" },
                        { "id": "emp-baro-5", "name": "THIAGO PEREIRA FRANGILO", "status": "active" }
                    ],
                    "ORGANIZAÇÃO E QUALIDADE": [{ "id": "emp-baro-25", "name": "LUIS", "status": "active" }]
                }
            },
            "injetoras": {
                "id": "injetoras",
                "name": "Organograma Injetoras de Cubos",
                "sectors": {
                    "SUPORTE E ORGANIZAÇÃO": [{ "id": "emp-inj-1640995200016", "name": "DANILO", "status": "active" }],
                    "LÍDER DE PRODUÇÃO": [{ "id": "emp-inj-1", "name": "JONESLEY ALVÃO", "status": "active" }],
                    "OPERADOR DE MÁQ / INJETORAS - CUBO": [
                        { "id": "emp-inj-1640995200000", "name": "JULIANO SEVERINO", "status": "active" },
                        { "id": "emp-inj-1640995200001", "name": "IGOR DE LIMA", "status": "active" },
                        { "id": "emp-inj-1640995200002", "name": "MARCIO LUIZ", "status": "active" },
                        { "id": "emp-inj-1640995200003", "name": "KAUAN DA SILVA", "status": "active" },
                        { "id": "emp-inj-1640995200004", "name": "BRUNO DE OLIVEIRA AR", "status": "active" },
                        { "id": "emp-inj-1640995200005", "name": "JUCIELIO PEREIRA DE", "status": "active" },
                        { "id": "emp-inj-1640995200006", "name": "LEONARDO HUDSON FERR", "status": "active" },
                        { "id": "emp-inj-1640995200008", "name": "ALEX DOS SANTOS", "status": "active" },
                        { "id": "emp-inj-1640995200009", "name": "RAFAEL AUGUSTO DA SI", "status": "active" },
                        { "id": "emp-inj-1640995200010", "name": "ADRIANO RODRIGO PALH", "status": "active" },
                        { "id": "emp-inj-1640995200011", "name": "RENAN DE OLIVEIRA", "status": "active" },
                        { "id": "emp-inj-1640995200013", "name": "JEAN JESUS DA PAIXAO", "status": "active" },
                        { "id": "emp-inj-1640995200015", "name": "ANDERSON VALBINO DA", "status": "active" },
                        { "id": "emp-inj-1640995200014", "name": "SIDNEY CARDOSO", "status": "active" }
                    ],
                    "MANUTENÇÃO": [
                        { "id": "emp-1756358769265", "name": "ALCIDES", "status": "active" },
                        { "id": "emp-1756358797025", "name": "ANTONIO", "status": "active" },
                        { "id": "emp-1756358827193", "name": "HELIO", "status": "active" },
                        { "id": "emp-1756386157319", "name": "GEOVANI DIAS", "status": "active" },
                        { "id": "emp-1756423463313", "name": "RANGEL", "status": "active" }
                    ],
                    "MANUTENCISTA OPERACIONAL": [{ "id": "emp-inj-1640995200007", "name": "MATEUS GODOY", "status": "active" }]
                }
            },
            "injetoraPcs": {
                "id": "injetoraPcs",
                "name": "Organograma Injetora de Pçs",
                "sectors": {
                    "OPERADO DE MÁQ / INJETORAS - PEÇAS": [
                        { "id": "emp-pcs-1", "name": "AGUINALDO BARONEL", "status": "active" },
                        { "id": "emp-pcs-2", "name": "CELIO SOARES DE SOUZ", "status": "active" },
                        { "id": "emp-pcs-3", "name": "CELSO NUNES OLIVEIRA", "status": "active" },
                        { "id": "emp-pcs-4", "name": "CLESIO SCOTINE", "status": "active" },
                        { "id": "emp-pcs-6", "name": "DANIEL ROSA GONÇALVE", "status": "active" },
                        { "id": "emp-pcs-7", "name": "DAVID RAFAEL CALDERA", "status": "active" },
                        { "id": "emp-pcs-8", "name": "EDUARDO VENTLANDO SO", "status": "active" },
                        { "id": "emp-pcs-9", "name": "GILBERTO AP PEREIRA", "status": "active" },
                        { "id": "emp-pcs-13", "name": "JHEMMY", "status": "active" },
                        { "id": "emp-pcs-14", "name": "JOAO SILVA MENDES", "status": "active" },
                        { "id": "emp-pcs-15", "name": "JUCELINO BARBOSA DA", "status": "active" },
                        { "id": "emp-pcs-17", "name": "JULIANO SEVERINO", "status": "active" },
                        { "id": "emp-pcs-18", "name": "MANOEL", "status": "active" },
                        { "id": "emp-pcs-19", "name": "MATHEUS FELIPE", "status": "active" },
                        { "id": "emp-pcs-20", "name": "MATHEUS SEBIN", "status": "active" },
                        { "id": "emp-pcs-23", "name": "ROBERTO CARLOS PEDRO", "status": "active" },
                        { "id": "emp-pcs-24", "name": "ROSALINO SANTOS TRIN", "status": "active" },
                        { "id": "emp-pcs-25", "name": "SIDNEI FERNANDES", "status": "active" },
                        { "id": "emp-pcs-27", "name": "VANILDO TORRET", "status": "active" },
                        { "id": "emp-pcs-28", "name": "VITOR STORK", "status": "active" },
                        { "id": "emp-pcs-29", "name": "WANDERLEI", "status": "active" }
                    ],
                    "MANUTENÇÃO": [
                        { "id": "emp-1756358642249", "name": "MATHEUS HENRIQUE", "status": "active" },
                        { "id": "emp-1756423596888", "name": "MÁRIO ", "status": "active" }
                    ],
                    "ACABAMENTO": [{ "id": "emp-1756385580807", "name": "MATHEUS SARGIN", "status": "active" }],
                    "JATO": [{ "id": "emp-1756385616993", "name": "JOSIAS ARAÚJO ", "status": "active" }],
                    "LÍDER DE PRODUÇÃO": [{ "id": "emp-pcs-lider-maicon", "name": "MAICON", "status": "active" }]
                }
            }
        };
        const initialHiringNeedsData = [{
            "id": "need-1756345798366",
            "factoryId": "pneus",
            "shiftId": "afternoon-shift",
            "sector": "CORTE DE LONA",
            "reasonType": "Desligamento de Funcionário",
            "employeeToReplace": "GISLAINE",
            "departureDate": "2025-09-26",
            "expectedStartDate": "2025-09-26",
            "keyResponsibilities": "CORTE DE LONA",
            "notes": ""
        }, {
            "id": "need-1756345940750",
            "factoryId": "pneus",
            "shiftId": "afternoon-shift",
            "sector": "MANUTENÇÃO",
            "reasonType": "Desligamento de Funcionário",
            "employeeToReplace": "JOSE LUAN",
            "departureDate": "",
            "expectedStartDate": "",
            "keyResponsibilities": "MANUTENÇÃO EM GERAL",
            "notes": ""
        }, {
            "id": "need-1756346054742",
            "factoryId": "pneus",
            "shiftId": "afternoon-shift",
            "sector": "VULCANIZAÇÃO",
            "reasonType": "Desligamento de Funcionário",
            "employeeToReplace": "HIGOR GONÇALVES",
            "departureDate": "",
            "expectedStartDate": "",
            "keyResponsibilities": "VULCANIZAÇÃO E REVEZAMENTO ENTRE SETORES",
            "notes": ""
        }, {
            "id": "need-1756358565793",
            "factoryId": "injetoraPcs",
            "shiftId": null,
            "sector": "OPERADO DE MÁQ / INJETORAS - PEÇAS",
            "reasonType": "Desligamento de Funcionário",
            "employeeToReplace": "JHEMMY",
            "departureDate": "",
            "expectedStartDate": "",
            "keyResponsibilities": "OPERADOR DE MAQUINA",
            "notes": ""
        }, {
            "id": "need-1756381764053",
            "factoryId": "bAro",
            "shiftId": null,
            "sector": "LIXADEIRAS",
            "reasonType": "Nova Posição",
            "employeeToReplace": "",
            "departureDate": "",
            "expectedStartDate": "2025-10-01",
            "keyResponsibilities": "Lixadeiras",
            "notes": "Ja efetivamos Guilherme, agora só falta a mais um funcionário "
        }, {
            "id": "need-1756384192623",
            "factoryId": "pneus",
            "shiftId": "morning-shift",
            "sector": "TALÃO",
            "reasonType": "Desligamento de Funcionário",
            "employeeToReplace": "luan",
            "departureDate": "",
            "expectedStartDate": "",
            "keyResponsibilities": "",
            "notes": ""
        }, {
            "id": "need-1756384246945",
            "factoryId": "pneus",
            "shiftId": "morning-shift",
            "sector": "VULCANIZAÇÃO",
            "reasonType": "Desligamento de Funcionário",
            "employeeToReplace": "Ronaldo ",
            "departureDate": "",
            "expectedStartDate": "",
            "keyResponsibilities": "Vulcanização ",
            "notes": "Nao está comparecendo trabalho."
        }];
        const initialLogData = [{
            "id": "log-initial-1", "type": "SAÍDA", "date": "26/09/2025", "employeeName": "GISLAINE", "context": "Pneus / TURNO DA TARDE / CORTE DE LONA"
        }, {
            "id": "log-initial-2", "type": "SAÍDA", "date": "28/09/2025", "employeeName": "JOSE LUAN", "context": "Pneus / TURNO DA TARDE / MANUTENÇÃO"
        }, {
            "id": "log-initial-3", "type": "SAÍDA", "date": "28/09/2025", "employeeName": "HIGOR GONÇALVES", "context": "Pneus / TURNO DA TARDE / VULCANIZAÇÃO"
        }, {
            "id": "log-1756358642249", "type": "ENTRADA", "date": "28/09/2025", "employeeName": "ADICIONAR", "context": "Organograma Injetora de Pçs / MANUTENÇÃO"
        }, {
            "id": "log-1756358696105", "type": "ENTRADA", "date": "28/09/2025", "employeeName": "ADICIONAR", "context": "Organograma Injetoras de Cubos / MANUTENCISTA OPERACIONAL"
        }, {
            "id": "log-1756358738745", "type": "SAÍDA", "date": "28/09/2025", "employeeName": "ADICIONAR", "context": "Organograma Injetoras de Cubos / MANUTENCISTA OPERACIONAL"
        }, {
            "id": "log-1756358769265", "type": "ENTRADA", "date": "28/09/2025", "employeeName": "ALCIDES", "context": "Organograma Injetoras de Cubos / MANUTENÇÃO"
        }, {
            "id": "log-1756358797025", "type": "ENTRADA", "date": "28/09/2025", "employeeName": "ANTONIO", "context": "Organograma Injetoras de Cubos / MANUTENÇÃO"
        }, {
            "id": "log-1756358827193", "type": "ENTRADA", "date": "28/09/2025", "employeeName": "HELIO", "context": "Organograma Injetoras de Cubos / LÍDER DE PRODUÇÃO"
        }, {
            "id": "log-1756380093840", "type": "ENTRADA", "date": "28/09/2025", "employeeName": "GUILHERME NOVATO", "context": "Organograma B-Aro / LIXADEIRAS"
        }, {
            "id": "log-1756385423236", "type": "SAÍDA", "date": "28/09/2025", "employeeName": "DANILO", "context": "Organograma Injetora de Pçs / OPERADO DE MÁQ / INJETORAS - PEÇAS"
        }, {
            "id": "log-1756385447001", "type": "SAÍDA", "date": "28/09/2025", "employeeName": "GUILHERME MURBACH DA", "context": "Organograma Injetora de Pçs / OPERADO DE MÁQ / INJETORAS - PEÇAS"
        }, {
            "id": "log-1756385453359", "type": "SAÍDA", "date": "28/09/2025", "employeeName": "IGOR DE LIMA", "context": "Organograma Injetora de Pçs / OPERADO DE MÁQ / INJETORAS - PEÇAS"
        }, {
            "id": "log-1756385459949", "type": "SAÍDA", "date": "28/09/2025", "employeeName": "JEAN JESUS DA PAIXAO", "context": "Organograma Injetora de Pçs / OPERADO DE MÁQ / INJETORAS - PEÇAS"
        }, {
            "id": "log-1756385475257", "type": "SAÍDA", "date": "28/09/2025", "employeeName": "JUCIELIO PEREIRA DE", "context": "Organograma Injetora de Pçs / OPERADO DE MÁQ / INJETORAS - PEÇAS"
        }, {
            "id": "log-1756385485283", "type": "SAÍDA", "date": "28/09/2025", "employeeName": "RENAN DE OLIVEIRA", "context": "Organograma Injetora de Pçs / OPERADO DE MÁQ / INJETORAS - PEÇAS"
        }, {
            "id": "log-1756385489341", "type": "SAÍDA", "date": "28/09/2025", "employeeName": "RAFAEL AUGUSTO DA SI", "context": "Organograma Injetora de Pçs / OPERADO DE MÁQ / INJETORAS - PEÇAS"
        }, {
            "id": "log-1756385494720", "type": "SAÍDA", "date": "28/09/2025", "employeeName": "SIDNEY CARDOSO", "context": "Organograma Injetora de Pçs / OPERADO DE MÁQ / INJETORAS - PEÇAS"
        }, {
            "id": "log-1756385580808", "type": "ENTRADA", "date": "28/09/2025", "employeeName": "MATHEUS SARGIN", "context": "Organograma Injetora de Pçs / ACABAMENTO"
        }, {
            "id": "log-1756385616993", "type": "ENTRADA", "date": "28/09/2025", "employeeName": "JOSIAS ARAÚJO ", "context": "Organograma Injetora de Pçs / JATO"
        }, {
            "id": "log-1756385930123", "type": "SAÍDA", "date": "28/09/2025", "employeeName": "LUCAS DE SOUZA GODOY", "context": "Organograma Injetoras de Cubos / OPERADOR DE MÁQ / INJETORAS - CUBO"
        }, {
            "id": "log-1756386157319", "type": "ENTRADA", "date": "28/09/2025", "employeeName": "GEOVANI DIAS", "context": "Organograma Injetoras de Cubos / MANUTENÇÃO"
        }, {
            "id": "log-1756423463313", "type": "ENTRADA", "date": "28/09/2025", "employeeName": "RANGEL", "context": "Organograma Injetoras de Cubos / MANUTENÇÃO"
        }, {
            "id": "log-1756423596888", "type": "ENTRADA", "date": "28/09/2025", "employeeName": "MÁRIO ", "context": "Organograma Injetora de Pçs / MANUTENÇÃO"
        }];

        // Módulo principal da aplicação para organizar o código
        const App = (() => {
            // --- Variáveis de Estado Global ---
            let factories = {};
            let hiringNeeds = [];
            let log = [];
            let selectedShiftId = null;
            let currentFactoryId = 'pneus';
            let currentView = 'organograma';
            let currentOrgSubView = 'overview';
            let isAdminLoggedIn = false;
            const ADMIN_PASSWORD = "FBK123";
            let confirmCallback = null;
            
            // Variáveis do Firebase
            let db, auth, currentUser = null;
            let unsubscribe; // Para o listener do Firestore
            let syncStatus = 'idle'; // idle, dirty, syncing, synced, error
            let isDirty = false;
            let saveTimeout = null;
            let isAppReady = false; // Flag de controlo
            const SAVE_DELAY = 2500; // 2.5 segundos

            // --- Cache de Elementos DOM ---
            const navigationContainer = document.getElementById('navigation-container');
            const mainContentArea = document.getElementById('main-content-area');
            const modalBackdrop = document.getElementById('modal-backdrop');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const modalCloseBtn = document.getElementById('modal-close-btn');
            const messageContainer = document.getElementById('message-container');
            const confirmModalBackdrop = document.getElementById('confirm-modal-backdrop');
            const confirmModalTitle = document.getElementById('confirm-modal-title');
            const confirmModalMessage = document.getElementById('confirm-modal-message');
            const confirmModalOkBtn = document.getElementById('confirm-modal-ok-btn');
            const adminLoginSection = document.getElementById('admin-login-section');
            const adminLogoutSection = document.getElementById('admin-logout-section');
            const adminPasswordInput = document.getElementById('admin-password-input');
            const adminLoginBtn = document.getElementById('admin-login-btn');
            const adminLogoutBtn = document.getElementById('admin-logout-btn');
            const logoContainer = document.getElementById('logo-container');
            const syncStatusElement = document.getElementById('sync-status');
            const saveCloudBtn = document.getElementById('save-cloud-btn');


            // --- Funções Utilitárias ---
            const showMessage = (message, type = 'success') => {
                const div = document.createElement('div');
                div.className = `p-3 rounded-md shadow-lg mb-2 text-white text-sm animate-pulse ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
                div.textContent = message;
                messageContainer.appendChild(div);
                setTimeout(() => div.classList.remove('animate-pulse'), 100);
                setTimeout(() => div.remove(), 4000);
            };
            const showModal = (title, content) => {
                modalTitle.textContent = title;
                modalBody.innerHTML = content;
                modalBackdrop.classList.remove('hidden');
            };
            const hideModal = () => modalBackdrop.classList.add('hidden');
            const showConfirmModal = (title, message, callback) => {
                confirmModalTitle.textContent = title;
                confirmModalMessage.textContent = message;
                confirmCallback = callback;
                confirmModalBackdrop.classList.remove('hidden');
            };
            const hideConfirmModal = () => {
                confirmModalBackdrop.classList.add('hidden');
                confirmCallback = null;
            };
            const updateSyncStatus = (status, message) => {
                syncStatus = status;
                syncStatusElement.textContent = message;
                syncStatusElement.className = `text-xs font-semibold ${status}`;
            };


            // --- Funções de Admin ---
            const loginAdmin = () => {
                if (adminPasswordInput.value === ADMIN_PASSWORD) {
                    isAdminLoggedIn = true;
                    localStorage.setItem('isAdminLoggedIn', 'true');
                    showMessage("Login de administrador bem-sucedido!", 'success');
                    adminPasswordInput.value = '';
                    renderApp();
                } else {
                    showMessage("Senha de administrador incorreta.", 'error');
                }
            };
            const logoutAdmin = () => {
                isAdminLoggedIn = false;
                localStorage.removeItem('isAdminLoggedIn');
                showMessage("Logout de administrador bem-sucedido!", 'success');
                renderApp();
            };
            
            // --- Funções de Ajuda ---
            const getActiveEmployees = (employeeList = []) => {
                return employeeList.filter(emp => emp.status === 'active');
            };
            const getAllEmployeesFromShift = (shift) => Object.values(shift.functions || {}).flat();
            const getAllEmployeesFromFactory = (factory) => {
                if (!factory) return [];
                if (factory.shifts) return factory.shifts.flatMap(getAllEmployeesFromShift);
                if (factory.sectors) return Object.values(factory.sectors).flat();
                return [];
            };
            const getSectorsForFactory = (factoryId) => {
                const factory = factories[factoryId];
                if (!factory) return [];
                const sectors = new Set();
                if (factory.shifts) factory.shifts.forEach(shift => Object.keys(shift.functions || {}).forEach(func => sectors.add(func)));
                else if (factory.sectors) Object.keys(factory.sectors || {}).forEach(sector => sectors.add(sector));
                return Array.from(sectors).sort();
            };

            // --- NOVO Sistema de Salvamento ---
            function scheduleSave() {
                if (!isAppReady) return; // Não agendar salvamentos antes da app estar pronta
                isDirty = true;
                updateSyncStatus('dirty', 'Alterações pendentes...');
                if (saveTimeout) {
                    clearTimeout(saveTimeout);
                }
                saveTimeout = setTimeout(() => saveDataToFirestore(false), SAVE_DELAY);
            }

            async function saveDataToFirestore(isManual = false) {
                if (!isAppReady) return; // Guarda de segurança
                if (!isDirty && !isManual) return;

                if (saveTimeout) {
                    clearTimeout(saveTimeout);
                    saveTimeout = null;
                }
                if (!db || !currentUser) {
                    updateSyncStatus('error', 'Não autenticado');
                    if (isManual) showMessage("Não autenticado. Não é possível salvar.", "error");
                    return;
                }
                const docRef = getDocRef();
                if (!docRef) {
                    updateSyncStatus('error', 'Não autenticado');
                    if (isManual) showMessage("ID do utilizador não encontrado. Não é possível salvar.", "error");
                    return;
                }

                updateSyncStatus('syncing', 'Salvando na nuvem...');
                try {
                    const dataToSave = {
                        factoriesData: JSON.stringify(factories),
                        hiringNeedsData: JSON.stringify(hiringNeeds),
                        logData: JSON.stringify(log)
                    };
                    await setDoc(docRef, dataToSave);
                    isDirty = false;
                    updateSyncStatus('synced', 'Salvo na nuvem');
                    if (isManual) showMessage("Dados salvos com sucesso.", "success");
                } catch (error) {
                    isDirty = true; // Mantém o estado sujo para tentar novamente
                    console.error("Erro ao salvar dados: ", error);
                    updateSyncStatus('error', 'Erro ao salvar');
                    if (isManual) showMessage("Não foi possível salvar os dados na nuvem.", "error");
                }
            }
            
            function handleAddEmployee(factoryId, contextId = null) {
                const factory = factories[factoryId];
                let modalTitleText = `Adicionar Funcionário a ${factory.name}`;
                if (factoryId === 'pneus') {
                    const shift = factory.shifts.find(s => s.id === contextId);
                    if (!shift) return;
                    modalTitleText = `Adicionar Funcionário a ${shift.name}`;
                }
                const modalContent = `<div class="space-y-4"><div><label for="add-employee-name" class="block text-sm font-medium text-gray-700">Nome</label><input type="text" id="add-employee-name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3" /></div><div><label for="add-employee-sector" class="block text-sm font-medium text-gray-700">Setor/Função</label><input type="text" id="add-employee-sector" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3" placeholder="Ex: CALDEIRA" /></div><button data-action="save-new-employee" data-factory-id="${factoryId}" data-context-id="${contextId || ''}" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Salvar</button></div>`;
                showModal(modalTitleText, modalContent);
            }
            async function saveNewEmployee(factoryId, contextId) {
                const name = document.getElementById('add-employee-name')?.value.toUpperCase().trim();
                const sector = document.getElementById('add-employee-sector')?.value.toUpperCase().trim();
                if (!name || !sector) return showMessage("Nome e setor são obrigatórios.", 'error');

                const newEmployee = { id: `emp-${Date.now()}`, name, status: 'active' };
                let contextName = '';
                if (factoryId === 'pneus') {
                    const shift = factories.pneus.shifts.find(s => s.id === contextId);
                    if (!shift) return showMessage("Turno não encontrado.", 'error');
                    if (!shift.functions[sector]) shift.functions[sector] = [];
                    shift.functions[sector].push(newEmployee);
                    contextName = `Pneus / ${shift.name} / ${sector}`;
                } else {
                    const factory = factories[factoryId];
                    if (!factory) return showMessage("Fábrica não encontrada.", 'error');
                    if (!factory.sectors[sector]) factory.sectors[sector] = [];
                    factory.sectors[sector].push(newEmployee);
                    contextName = `${factory.name} / ${sector}`;
                }
                log.push({ id: `log-${Date.now()}`, type: 'ENTRADA', date: new Date().toLocaleDateString('pt-BR'), employeeName: name, context: contextName });
                hideModal();
                scheduleSave();
            }
            function handleEditEmployee(factoryId, contextId, sectorName, employeeId) {
                let employee;
                if (factoryId === 'pneus') {
                    const shift = factories.pneus.shifts.find(s => s.id === contextId);
                    employee = shift?.functions?.[sectorName]?.find(e => e.id === employeeId);
                } else {
                    employee = factories[factoryId]?.sectors?.[sectorName]?.find(e => e.id === employeeId);
                }
                if (!employee) return showMessage("Funcionário não encontrado.", "error");

                const isTerminated = employee.status === 'terminated';
                const actionButton = isTerminated
                    ? `<button data-action="reactivate-employee" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md">Reativar</button>`
                    : `<button data-action="terminate-employee" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md">Desligar</button>`;

                const modalContent = `
                    <div class="space-y-4">
                        <input type="hidden" id="edit-employee-id" value="${employee.id}" /><input type="hidden" id="edit-employee-factory-id" value="${factoryId}" /><input type="hidden" id="edit-employee-context-id" value="${contextId || ''}" /><input type="hidden" id="edit-employee-old-sector" value="${sectorName}" />
                        <div><label for="edit-employee-name" class="block text-sm font-medium text-gray-700">Nome</label><input type="text" id="edit-employee-name" value="${employee.name}" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 ${isTerminated ? 'bg-gray-200' : ''}" ${isTerminated ? 'disabled' : ''}/></div>
                        <div><label for="edit-employee-sector" class="block text-sm font-medium text-gray-700">Setor/Função</label><input type="text" id="edit-employee-sector" value="${sectorName}" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 ${isTerminated ? 'bg-gray-200' : ''}" ${isTerminated ? 'disabled' : ''}/></div>
                        <div class="flex justify-between space-x-4 mt-6"><button data-action="save-edited-employee" class="flex-grow bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md ${isTerminated ? 'hidden' : ''}">Salvar Alterações</button>${actionButton}</div>
                    </div>`;
                showModal(`Editar ${employee.name}`, modalContent);
            }
            async function saveEditedEmployee() {
                const employeeId = document.getElementById('edit-employee-id').value, factoryId = document.getElementById('edit-employee-factory-id').value, contextId = document.getElementById('edit-employee-context-id').value, oldSectorName = document.getElementById('edit-employee-old-sector').value, newName = document.getElementById('edit-employee-name').value.toUpperCase().trim(), newSectorName = document.getElementById('edit-employee-sector').value.toUpperCase().trim();
                if (!newName || !newSectorName) return showMessage("Nome e setor são obrigatórios.", 'error');

                let employeeToMove;
                
                if (factoryId === 'pneus') {
                    const shift = factories.pneus.shifts.find(s => s.id === contextId);
                    if (shift?.functions?.[oldSectorName]) {
                        const employeeIndex = shift.functions[oldSectorName].findIndex(e => e.id === employeeId);
                        if (employeeIndex > -1) {
                            [employeeToMove] = shift.functions[oldSectorName].splice(employeeIndex, 1);
                        }
                        if (shift.functions[oldSectorName].length === 0) delete shift.functions[oldSectorName];
                    }
                } else {
                    if (factories[factoryId]?.sectors?.[oldSectorName]) {
                        const employeeIndex = factories[factoryId].sectors[oldSectorName].findIndex(e => e.id === employeeId);
                        if (employeeIndex > -1) {
                            [employeeToMove] = factories[factoryId].sectors[oldSectorName].splice(employeeIndex, 1);
                        }
                        if (factories[factoryId].sectors[oldSectorName].length === 0) delete factories[factoryId].sectors[oldSectorName];
                    }
                }

                if (!employeeToMove) return showMessage("Funcionário original não encontrado para mover.", "error");
                
                employeeToMove.name = newName;

                if (factoryId === 'pneus') {
                    const shift = factories.pneus.shifts.find(s => s.id === contextId);
                    if (!shift.functions[newSectorName]) shift.functions[newSectorName] = [];
                    shift.functions[newSectorName].push(employeeToMove);
                } else {
                    if (!factories[factoryId].sectors[newSectorName]) factories[factoryId].sectors[newSectorName] = [];
                    factories[factoryId].sectors[newSectorName].push(employeeToMove);
                }
                
                hideModal();
                scheduleSave();
            }
            function handleTerminateEmployee() {
                const employeeName = document.getElementById('edit-employee-name').value;
                showConfirmModal('Desligar Funcionário', `Tem certeza que deseja marcar '${employeeName}' como desligado?`,
                    async (confirmed) => {
                        if (!confirmed) return;
                        const employeeId = document.getElementById('edit-employee-id').value, factoryId = document.getElementById('edit-employee-factory-id').value, contextId = document.getElementById('edit-employee-context-id').value, oldSectorName = document.getElementById('edit-employee-old-sector').value;
                        let contextName = '', employee;

                        if (factoryId === 'pneus') {
                            const shift = factories.pneus.shifts.find(s => s.id === contextId);
                            employee = shift?.functions?.[oldSectorName]?.find(e => e.id === employeeId);
                            contextName = `Pneus / ${shift.name} / ${oldSectorName}`;
                        } else {
                            employee = factories[factoryId]?.sectors?.[oldSectorName]?.find(e => e.id === employeeId);
                            contextName = `${factories[factoryId].name} / ${oldSectorName}`;
                        }

                        if (employee) {
                            employee.status = 'terminated';
                            log.push({ id: `log-${Date.now()}`, type: 'SAÍDA', date: new Date().toLocaleDateString('pt-BR'), employeeName: employee.name, context: contextName });
                            hideModal();
                            scheduleSave();
                            
                            setTimeout(() => showConfirmModal('Criar Vaga de Contratação?', `Deseja abrir uma nova vaga para substituir '${employee.name}' no setor '${oldSectorName}'?`,
                                (createNeed) => { if (createNeed) handleAddHiringNeed({ factoryId, shiftId: contextId, sector: oldSectorName, reasonType: 'Desligamento de Funcionário', employeeToReplace: employee.name, departureDate: new Date().toISOString().split('T')[0] }); }
                            ), 100);
                        } else { showMessage("Erro ao encontrar funcionário para desligar.", "error"); }
                    }
                );
            }
            async function handleReactivateEmployee() {
                const employeeId = document.getElementById('edit-employee-id').value, factoryId = document.getElementById('edit-employee-factory-id').value, contextId = document.getElementById('edit-employee-context-id').value, oldSectorName = document.getElementById('edit-employee-old-sector').value;
                let contextName = '', employee;

                if (factoryId === 'pneus') {
                    const shift = factories.pneus.shifts.find(s => s.id === contextId);
                    employee = shift?.functions?.[oldSectorName]?.find(e => e.id === employeeId);
                    contextName = `Pneus / ${shift.name} / ${oldSectorName}`;
                } else {
                    employee = factories[factoryId]?.sectors?.[oldSectorName]?.find(e => e.id === employeeId);
                    contextName = `${factories[factoryId].name} / ${oldSectorName}`;
                }

                if (employee) {
                    employee.status = 'active';
                    log.push({ id: `log-${Date.now()}`, type: 'ENTRADA', date: new Date().toLocaleDateString('pt-BR'), employeeName: employee.name, context: `Reativado em ${contextName}` });
                    hiringNeeds = hiringNeeds.filter(need => !(need.reasonType === 'Desligamento de Funcionário' && need.employeeToReplace?.toUpperCase() === employee.name.toUpperCase() && need.factoryId === factoryId && need.sector === oldSectorName));
                    hideModal();
                    scheduleSave();
                    showMessage(`${employee.name} foi reativado com sucesso.`, "success");
                } else { showMessage("Erro ao encontrar funcionário para reativar.", "error"); }
            }
            
            function handleAddHiringNeed(prefill = {}) {
                const factoryOptions = Object.values(factories).map(f => `<option value="${f.id}" ${prefill.factoryId === f.id ? 'selected' : ''}>${f.name}</option>`).join('');
                const modalContent = `<div class="space-y-4 text-left"><div><label class="block text-sm font-medium text-gray-700">Fábrica</label><select id="hiring-need-factory" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">${factoryOptions}</select></div><div id="shift-selector-container" class="hidden"><label class="block text-sm font-medium text-gray-700">Turno</label><select id="hiring-need-shift" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></select></div><div><label class="block text-sm font-medium text-gray-700">Setor (Função)</label><select id="hiring-need-sector" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"><option value="">Selecione</option></select></div><div><label class="block text-sm font-medium text-gray-700">Motivo</label><select id="hiring-need-reasonType" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"><option value="">Selecione</option><option value="Aumento de Produção" ${prefill.reasonType === 'Aumento de Produção' ? 'selected' : ''}>Aumento de Produção</option><option value="Desligamento de Funcionário" ${prefill.reasonType === 'Desligamento de Funcionário' ? 'selected' : ''}>Desligamento</option><option value="Nova Posição" ${prefill.reasonType === 'Nova Posição' ? 'selected' : ''}>Nova Posição</option><option value="Outro" ${prefill.reasonType === 'Outro' ? 'selected' : ''}>Outro</option></select></div><div id="replacement-fields" class="hidden space-y-4"><div><label class="block text-sm font-medium text-gray-700">Substituindo</label><input type="text" id="hiring-need-employeeToReplace" value="${prefill.employeeToReplace || ''}" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3" /></div><div><label class="block text-sm font-medium text-gray-700">Data Desligamento</label><input type="date" id="hiring-need-departureDate" value="${prefill.departureDate || ''}" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3" /></div></div><div><label class="block text-sm font-medium text-gray-700">Início Previsto</label><input type="date" id="hiring-need-expectedStartDate" value="${prefill.expectedStartDate || ''}" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3" /></div><div><label class="block text-sm font-medium text-gray-700">Responsabilidades</label><textarea id="hiring-need-keyResponsibilities" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">${prefill.keyResponsibilities || ''}</textarea></div><div><label class="block text-sm font-medium text-gray-700">Observações</label><textarea id="hiring-need-notes" rows="2" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">${prefill.notes || ''}</textarea></div><button data-action="save-new-hiring-need" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Salvar</button></div>`;
                showModal("Criar Nova Necessidade de Contratação", modalContent);
                document.getElementById('hiring-need-factory').dispatchEvent(new Event('change'));
                if(prefill.sector) document.getElementById('hiring-need-sector').value = prefill.sector;
            }
            async function handleSaveNewHiringNeed() {
                const newNeed = { id: `need-${Date.now()}`, factoryId: document.getElementById('hiring-need-factory').value, shiftId: document.getElementById('hiring-need-shift').value || null, sector: document.getElementById('hiring-need-sector').value, reasonType: document.getElementById('hiring-need-reasonType').value, employeeToReplace: document.getElementById('hiring-need-employeeToReplace').value, departureDate: document.getElementById('hiring-need-departureDate').value, expectedStartDate: document.getElementById('hiring-need-expectedStartDate').value, keyResponsibilities: document.getElementById('hiring-need-keyResponsibilities').value, notes: document.getElementById('hiring-need-notes').value };
                if (!newNeed.factoryId || !newNeed.sector || !newNeed.reasonType) return showMessage("Fábrica, Setor e Motivo são obrigatórios.", 'error');
                hiringNeeds.push(newNeed);
                hideModal();
                scheduleSave();
            }

            // --- Funções de Renderização ---
            function renderNavigation() {
                navigationContainer.innerHTML = `
                <h2 class="text-xl font-semibold mb-4 border-b border-blue-700 pb-2">Fábricas</h2>
                <ul class="space-y-3">${Object.keys(factories).length > 0 ? Object.values(factories).map(f => `<li><button data-factory="${f.id}" class="factory-btn w-full text-left py-2 px-4 rounded-md transition ${currentFactoryId === f.id ? 'bg-blue-700 font-bold' : 'hover:bg-blue-800'}">${f.name}</button></li>`).join('') : '<p class="text-blue-300 text-sm px-4">Carregando fábricas...</p>'}</ul>
                <h2 class="text-xl font-semibold my-4 border-b border-blue-700 pb-2">Vistas</h2>
                <ul class="space-y-3">
                    <li><button data-action="show-hiring-needs" class="w-full text-left py-2 px-4 rounded-md transition ${currentView === 'hiringNeedsOverview' ? 'bg-orange-600 font-bold' : 'bg-orange-500 hover:bg-orange-600'}">Necessidades Contratação</button></li>
                    <li><button data-action="show-log" class="w-full text-left py-2 px-4 rounded-md transition ${currentView === 'logView' ? 'bg-indigo-600 font-bold' : 'bg-indigo-500 hover:bg-indigo-600'}">Log de Movimentações</button></li>
                </ul>`;
                adminLoginSection.classList.toggle('hidden', isAdminLoggedIn);
                adminLogoutSection.classList.toggle('hidden', !isAdminLoggedIn);
            }

            function renderMainContent() {
                mainContentArea.innerHTML = '';
                if (currentView === 'hiringNeedsOverview') return renderHiringNeedsOverview(mainContentArea);
                if (currentView === 'logView') return renderLogView(mainContentArea);
                if (currentFactoryId === 'pneus') {
                    if (currentView === 'detailedShift') return renderDetailedShiftView(mainContentArea);
                    mainContentArea.innerHTML = `<div class="w-full max-w-7xl bg-white rounded-xl shadow-2xl p-6 sm:p-8 lg:p-10 mx-auto"><div class="sub-nav-tabs mb-8 no-print"><button data-action="set-subview" data-subview="overview" class="sub-nav-btn ${currentOrgSubView === 'overview' ? 'active' : ''}">Resumo</button><button data-action="set-subview" data-subview="fullchart" class="sub-nav-btn ${currentOrgSubView === 'fullchart' ? 'active' : ''}">Organograma</button></div><div id="organograma-sub-content"></div></div>`;
                    const subContentContainer = document.getElementById('organograma-sub-content');
                    if (currentOrgSubView === 'overview') return renderAllShiftsOverview(subContentContainer);
                    if (currentOrgSubView === 'fullchart') return renderFullOrgChart(subContentContainer);
                } else if (factories[currentFactoryId]) {
                    mainContentArea.innerHTML = `<div class="w-full max-w-7xl bg-white rounded-xl shadow-2xl p-6 sm:p-8 lg:p-10 mx-auto"><div class="sub-nav-tabs mb-8 no-print"><button data-action="set-subview" data-subview="overview" class="sub-nav-btn ${currentOrgSubView === 'overview' ? 'active' : ''}">Resumo</button><button data-action="set-subview" data-subview="fullchart" class="sub-nav-btn ${currentOrgSubView === 'fullchart' ? 'active' : ''}">Organograma</button></div><div id="organograma-sub-content"></div></div>`;
                    const subContentContainer = document.getElementById('organograma-sub-content');
                    if (currentOrgSubView === 'overview') return renderFactoryOverview(subContentContainer, currentFactoryId);
                    if (currentOrgSubView === 'fullchart') return renderFactoryFullChart(subContentContainer, currentFactoryId);
                } else {
                    mainContentArea.innerHTML = `<div class="w-full max-w-xl mx-auto bg-white rounded-xl shadow-2xl p-8 text-center"><p class="text-xl text-gray-600">Selecione uma opção no menu.</p></div>`;
                }
            }
            
            // --- Lógica de Eventos ---
            function handleNavClick(e) {
                const target = e.target.closest('button');
                if (!target) return;
                const { action, factory } = target.dataset;
                if (factory) {
                    currentFactoryId = factory;
                    currentView = 'organograma';
                    currentOrgSubView = 'overview';
                    selectedShiftId = null;
                } else if (action === 'show-hiring-needs') currentView = 'hiringNeedsOverview';
                else if (action === 'show-log') currentView = 'logView';
                renderApp();
            }

            function handleMainContentClick(e) {
                const target = e.target.closest('button, .employee-card');
                if (!target) return;
                const { action, subview, shiftId, factoryId, contextId, sectorName, employeeId } = target.dataset;
                if (action === 'set-subview') {
                    currentOrgSubView = subview;
                    renderApp();
                } else if (action === 'view-shift-details') {
                    selectedShiftId = shiftId;
                    currentView = 'detailedShift';
                    renderApp();
                } else if (action === 'print-page') window.print();
                else if (isAdminLoggedIn && target.classList.contains('employee-card')) handleEditEmployee(factoryId, contextId, sectorName, employeeId);
                else if (isAdminLoggedIn && action === 'add-hiring-need') handleAddHiringNeed();
                 else if (isAdminLoggedIn && action === 'add-employee') {
                    handleAddEmployee(factoryId, contextId);
                }
            }

            function handleModalEvents(e) {
                const target = e.target.closest('button, select');
                if (!target) return;
                const { action, factoryId, contextId } = target.dataset;
                if (action === 'save-new-employee') saveNewEmployee(factoryId, contextId);
                else if (action === 'save-edited-employee') saveEditedEmployee();
                else if (action === 'terminate-employee') handleTerminateEmployee();
                else if (action === 'reactivate-employee') handleReactivateEmployee();
                else if (action === 'save-new-hiring-need') handleSaveNewHiringNeed();
                else if (target.id === 'hiring-need-factory' || target.id === 'hiring-need-reasonType') {
                    const factoryId = document.getElementById('hiring-need-factory').value;
                    const factory = factories[factoryId];
                    const shiftContainer = document.getElementById('shift-selector-container');
                    const shiftSelect = document.getElementById('hiring-need-shift');
                    const sectorSelect = document.getElementById('hiring-need-sector');
                    const sectors = getSectorsForFactory(factoryId);
                    sectorSelect.innerHTML = '<option value="">Selecione</option>' + sectors.map(s => `<option value="${s}">${s}</option>`).join('');
                    if (factory?.shifts) {
                        shiftContainer.classList.remove('hidden');
                        shiftSelect.innerHTML = '<option value="">Selecione</option>' + factory.shifts.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
                    } else {
                        shiftContainer.classList.add('hidden');
                        shiftSelect.innerHTML = '';
                    }
                    document.getElementById('replacement-fields').classList.toggle('hidden', document.getElementById('hiring-need-reasonType').value !== 'Desligamento de Funcionário');
                }
            }
            
            function getDocRef() {
                let appId = (typeof __app_id !== 'undefined' && __app_id) ? __app_id : 'default-app-id';
                appId = appId.replace(/[.\/]/g, '_');
                if (!appId) appId = 'default-app-id';
                const userId = currentUser?.uid;
                if (!userId) {
                    console.error("Utilizador não autenticado ou UID indisponível, não é possível obter a referência do documento.");
                    return null;
                }
                return doc(db, `artifacts/${appId}/users/${userId}/organograma/main`);
            }

            async function loadAndSyncData(user) {
                updateSyncStatus('syncing', 'Conectando...');
                const docRef = getDocRef(user);
                if (!docRef) {
                    updateSyncStatus('error', 'Falha de Auth');
                    showMessage("Não foi possível obter a referência do usuário para carregar os dados.", "error");
                    factories = JSON.parse(JSON.stringify(initialFactoriesData));
                    hiringNeeds = JSON.parse(JSON.stringify(initialHiringNeedsData));
                    log = JSON.parse(JSON.stringify(initialLogData));
                    renderApp();
                    return;
                }

                unsubscribe = onSnapshot(docRef, (snapshot) => {
                    if (snapshot.exists()) {
                        const data = snapshot.data();
                        factories = JSON.parse(data.factoriesData || '{}');
                        hiringNeeds = JSON.parse(data.hiringNeedsData || '[]');
                        log = JSON.parse(data.logData || '[]');
                        updateSyncStatus('synced', 'Salvo na nuvem');
                    } else {
                        factories = JSON.parse(JSON.stringify(initialFactoriesData));
                        hiringNeeds = JSON.parse(JSON.stringify(initialHiringNeedsData));
                        log = JSON.parse(JSON.stringify(initialLogData));
                        saveDataToFirestore(true); // Força o salvamento inicial
                    }
                    isDirty = false; // Reseta o estado 'dirty' ao carregar dados da nuvem
                    isAppReady = true; // App está pronta
                    renderApp(); 
                }, (error) => {
                    console.error("Erro no listener do Firestore:", error);
                    updateSyncStatus('error', 'Erro de conexão');
                    showMessage("Não foi possível conectar à nuvem. Verifique sua conexão.", "error");
                    isAppReady = true; // App está pronta, mas em modo offline
                });
            }


            function renderApp() {
                renderNavigation();
                renderMainContent();
            }

            async function init() {
                logoContainer.innerHTML = `<svg viewBox="0 0 200 50" class="w-full h-auto" fill="currentColor"><text x="10" y="40" font-family="Inter, sans-serif" font-size="35" font-weight="bold">FABRECK</text></svg>`;
                
                navigationContainer.addEventListener('click', handleNavClick);
                mainContentArea.addEventListener('click', handleMainContentClick);
                modalBody.addEventListener('click', handleModalEvents);
                modalBody.addEventListener('change', handleModalEvents);
                adminLoginBtn.addEventListener('click', loginAdmin);
                adminPasswordInput.addEventListener('keyup', (e) => e.key === 'Enter' && loginAdmin());
                adminLogoutBtn.addEventListener('click', logoutAdmin);
                saveCloudBtn.addEventListener('click', () => saveDataToFirestore(true));
                modalCloseBtn.addEventListener('click', hideModal);
                document.getElementById('confirm-modal-close-btn').addEventListener('click', hideConfirmModal);
                document.getElementById('confirm-modal-cancel-btn').addEventListener('click', hideConfirmModal);
                confirmModalOkBtn.addEventListener('click', () => { if (confirmCallback) confirmCallback(true); hideConfirmModal(); });

                const loadOfflineDataAndRender = () => {
                    factories = JSON.parse(JSON.stringify(initialFactoriesData));
                    hiringNeeds = JSON.parse(JSON.stringify(initialHiringNeedsData));
                    log = JSON.parse(JSON.stringify(initialLogData));
                    isAppReady = true;
                    renderApp();
                };

                try {
                    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
                    if (!firebaseConfig) throw new Error("Configuração do Firebase não encontrada.");

                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);

                    let authInitialized = false;

                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                           if (!authInitialized) {
                                authInitialized = true;
                                currentUser = user;
                                console.log("Usuário autenticado:", user.uid);
                                if (localStorage.getItem('isAdminLoggedIn') === 'true') {
                                    isAdminLoggedIn = true;
                                }
                                await loadAndSyncData(user);
                           }
                        } else {
                            // Se não houver utilizador (raro com login anónimo, mas seguro de tratar)
                            currentUser = null;
                            isAdminLoggedIn = false;
                            updateSyncStatus('error', 'Não autenticado');
                            loadOfflineDataAndRender();
                        }
                    });

                    updateSyncStatus('syncing', 'Autenticando...');
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Falha na inicialização ou autenticação do Firebase:", error);
                    updateSyncStatus('error', 'Falha na Conexão');
                    showMessage("Não foi possível conectar à nuvem. O app está em modo offline.", "error");
                    loadOfflineDataAndRender();
                }
            }

            window.addEventListener('DOMContentLoaded', init);
            
            // --- IMPLEMENTAÇÃO DAS FUNÇÕES DE RENDERIZAÇÃO COMPLETAS ---
            function renderAllShiftsOverview(container) {
                if (!factories.pneus || !factories.pneus.shifts) { container.innerHTML = '<p>Carregando...</p>'; return; }
                const shifts = factories.pneus.shifts;
                const content = shifts.length > 0 ? `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">${shifts.map(shift => {
                const needsForShift = hiringNeeds.filter(need => need.factoryId === 'pneus' && need.shiftId === shift.id);
                let hiringNeedsHtml = needsForShift.length > 0 ? `<div class="mt-4 pt-3 border-t border-blue-200"><h4 class="font-bold text-red-600 text-sm mb-1">VAGA EM ABERTO:</h4><ul class="list-disc list-inside text-sm text-red-800">${needsForShift.map(need => `<li>${need.sector}</li>`).join('')}</ul></div>` : '';
                const activeEmployeeCount = getActiveEmployees(getAllEmployeesFromShift(shift)).length;
                return `<div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-blue-500"><h3 class="text-xl font-bold text-blue-800 mb-2">${shift.name}</h3><p class="text-gray-700"><span class="font-semibold">Responsável:</span> ${shift.responsible}</p><p class="text-gray-700"><span class="font-semibold">Horário:</span> ${shift.time}</p><p class="text-gray-700 mt-2"><span class="font-semibold">Funcionários Ativos:</span> ${activeEmployeeCount}</p>${hiringNeedsHtml}<button data-action="view-shift-details" data-shift-id="${shift.id}" class="mt-4 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md transition">Ver Detalhes</button></div>`
                }).join('')}</div>` : `<p class="text-center text-gray-500 text-lg">Nenhum turno cadastrado.</p>`;
                container.innerHTML = `<div class="printable-area"><div class="flex justify-between items-center mb-4 no-print"><h2 class="text-3xl font-bold text-gray-800">Resumo de Todos os Turnos</h2><button data-action="print-page" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md transition">Imprimir</button></div><div class="print-header hidden"><svg viewBox="0 0 200 50" class="print-logo" fill="black"><text x="10" y="40" font-family="Inter, sans-serif" font-size="35" font-weight="bold">FABRECK</text></svg><h2 class="print-title">FABRECK PNEUS - RESUMO DE TURNOS</h2></div>${content}</div>`;
            }

            function renderFullOrgChart(container) {
                if (!factories.pneus || !factories.pneus.shifts) { container.innerHTML = '<p>Carregando...</p>'; return; }
                const shifts = factories.pneus.shifts;
                const orgChartContent = shifts.length > 0 ? `<div class="flex flex-col items-center"><div class="w-full flex flex-col lg:flex-row justify-around items-start gap-8 org-chart-columns">${shifts.map(shift => `<div class="flex flex-col items-center w-full lg:w-1/3 org-chart-column"><div class="bg-blue-800 text-white rounded-lg p-4 shadow-lg text-center w-full max-w-sm mb-4 shift-header"><h3>${shift.name}</h3><p>Responsável: ${shift.responsible}</p></div><div class="w-full space-y-4">${Object.entries(shift.functions).sort((a, b) => a[0].localeCompare(b[0])).map(([func, employees]) => `<div class="sector-card"><h4>${func}</h4><div class="space-y-2">${employees.map(emp => `<div class="employee-card bg-gray-50 rounded shadow-sm p-2 text-center text-sm ${isAdminLoggedIn ? 'cursor-pointer' : ''} ${emp.status === 'terminated' ? 'terminated' : ''}" data-factory-id="pneus" data-context-id="${shift.id}" data-sector-name="${func}" data-employee-id="${emp.id}">${emp.name}</div>`).join('')}</div></div>`).join('')}</div></div>`).join('')}</div></div>` : `<p class="text-center text-gray-500 text-lg">Nenhum turno cadastrado.</p>`;
                container.innerHTML = `<div class="printable-area"><div class="flex justify-between items-center mb-4 no-print"><h2 class="text-3xl font-bold text-gray-800">Organograma Estruturado</h2><button data-action="print-page" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md transition">Imprimir</button></div><div class="print-header hidden"><svg viewBox="0 0 200 50" class="print-logo" fill="black"><text x="10" y="40" font-family="Inter, sans-serif" font-size="35" font-weight="bold">FABRECK</text></svg><h2 class="print-title">FABRECK PNEUS</h2></div><div class="w-full overflow-x-auto p-4 org-chart-container">${orgChartContent}</div></div>`;
            }

            function renderDetailedShiftView(container) {
                if (!factories.pneus || !factories.pneus.shifts) { container.innerHTML = '<p>Carregando...</p>'; return; }
                const shift = factories.pneus.shifts.find(s => s.id === selectedShiftId);
                if (!shift) { currentView = 'organograma'; renderApp(); return; }

                const adminAddButton = isAdminLoggedIn
                    ? `<button data-action="add-employee" data-factory-id="pneus" data-context-id="${shift.id}" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md transition">Adicionar Funcionário</button>`
                    : '';

                const needsForShift = hiringNeeds.filter(need => need.factoryId === 'pneus' && need.shiftId === shift.id);
                let hiringNeedsHtml = needsForShift.length > 0 ? `<div class="mb-8 p-4 bg-red-50 border-l-4 border-red-500 rounded-r-lg"><h4 class="font-bold text-red-700 text-lg mb-2">Vagas em Aberto:</h4><ul class="list-disc list-inside text-red-800">${needsForShift.map(need => `<li><strong>${need.sector}:</strong> ${need.reasonType}</li>`).join('')}</ul></div>` : '';
                const functionsHtml = Object.keys(shift.functions).length > 0 ? `<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">${Object.entries(shift.functions).sort((a, b) => a[0].localeCompare(b[0])).map(([func, employees]) => `<div class="sector-card"><h4>${func}</h4><div class="space-y-2">${employees.map(emp => `<div class="employee-card bg-gray-50 rounded shadow-sm p-3 text-center ${isAdminLoggedIn ? 'cursor-pointer' : ''} ${emp.status === 'terminated' ? 'terminated' : ''}" data-factory-id="pneus" data-context-id="${shift.id}" data-sector-name="${func}" data-employee-id="${emp.id}">${emp.name}</div>`).join('')}</div></div>`).join('')}</div>` : `<p class="text-center text-gray-500 text-lg">Nenhum funcionário neste turno.</p>`;
                container.innerHTML = `<div class="w-full max-w-6xl bg-white rounded-xl shadow-2xl p-6 sm:p-8 lg:p-10 mx-auto printable-area"><div class="flex flex-wrap justify-between items-center gap-4 mb-4 no-print"><h2 class="text-3xl font-bold text-gray-800">Detalhes do Turno</h2><div class="flex items-center gap-2">${adminAddButton}<button data-action="print-page" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md transition">Imprimir</button></div></div><div class="print-header hidden"><svg viewBox="0 0 200 50" class="print-logo" fill="black"><text x="10" y="40" font-family="Inter, sans-serif" font-size="35" font-weight="bold">FABRECK</text></svg><h2 class="print-title">FABRECK PNEUS - ${shift.name}</h2></div><div class="bg-blue-100 rounded-lg p-5 mb-8 shadow-md text-center"><h2 class="text-3xl font-bold text-blue-900 mb-2">${shift.name}</h2><p class="text-blue-800 text-lg"><span class="font-semibold">Responsável:</span> ${shift.responsible}</p><p class="text-blue-800 text-lg"><span class="font-semibold">Horário:</span> ${shift.time}</p></div>${hiringNeedsHtml}<h3 class="text-2xl font-bold text-gray-800 mb-6 text-center border-b pb-3">Funcionários por Setor</h3>${functionsHtml}</div>`;
            }

            function renderFactoryOverview(container, factoryId) {
                const factory = factories[factoryId];
                if (!factory) { container.innerHTML = '<p>Carregando...</p>'; return; }
                const adminAddButton = isAdminLoggedIn ? `<button data-action="add-employee" data-factory-id="${factoryId}" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md transition">Adicionar Funcionário</button>` : '';
                const activeEmployeesCount = getActiveEmployees(getAllEmployeesFromFactory(factory)).length;
                const content = Object.keys(factory.sectors).length > 0 ? `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">${Object.entries(factory.sectors).sort((a,b) => a[0].localeCompare(b[0])).map(([sectorName, employees]) => { const needsForSector = hiringNeeds.filter(need => need.factoryId === factoryId && need.sector === sectorName); let hiringNeedsHtml = needsForSector.length > 0 ? `<div class="mt-4 pt-3 border-t border-blue-200"><h4 class="font-bold text-red-600 text-sm mb-1">VAGA EM ABERTO:</h4><ul class="list-disc list-inside text-sm text-red-800">${needsForSector.map(need => `<li>${need.sector}</li>`).join('')}</ul></div>` : ''; const activeSectorEmployees = getActiveEmployees(employees).length; return `<div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-blue-500"><h3 class="text-xl font-bold text-blue-800 mb-2">${sectorName}</h3><p class="text-gray-700 mt-2"><span class="font-semibold">Funcionários Ativos:</span> ${activeSectorEmployees}</p>${hiringNeedsHtml}</div>` }).join('')}</div>` : `<p class="text-center text-gray-500 text-lg">Nenhum setor cadastrado.</p>`;
                container.innerHTML = `<div class="printable-area"><div class="flex flex-wrap justify-between items-center gap-4 mb-4 no-print"><h2 class="text-3xl font-bold text-gray-800">Resumo de Setores ${factory.name}</h2><div class="flex items-center gap-2">${adminAddButton}<button data-action="print-page" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md transition">Imprimir</button></div></div><div class="print-header hidden"><svg viewBox="0 0 200 50" class="print-logo" fill="black"><text x="10" y="40" font-family="Inter, sans-serif" font-size="35" font-weight="bold">FABRECK</text></svg><h2 class="print-title">${factory.name.toUpperCase().replace('ORGANOGRAMA', 'FABRECK')} - RESUMO</h2></div><div class="text-center mb-8"><p class="text-xl text-gray-600">Total de Funcionários Ativos: ${activeEmployeesCount}</p></div>${content}</div>`;
            }

            function renderFactoryFullChart(container, factoryId) {
                const factory = factories[factoryId];
                if (!factory) { container.innerHTML = '<p>Carregando...</p>'; return; }
                const adminAddButton = isAdminLoggedIn ? `<button data-action="add-employee" data-factory-id="${factoryId}" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md transition">Adicionar Funcionário</button>` : '';
                const activeEmployeesCount = getActiveEmployees(getAllEmployeesFromFactory(factory)).length;
                const topSectorsOrder = ["LÍDER DE PRODUÇÃO", "SUPORTE E ORGANIZAÇÃO", "ORGANIZAÇÃO E QUALIDADE"];
                const allSectorEntries = Object.entries(factory.sectors);
                const topSectorEntries = allSectorEntries.filter(([sectorName]) => topSectorsOrder.includes(sectorName.toUpperCase())).sort((a, b) => topSectorsOrder.indexOf(a[0].toUpperCase()) - topSectorsOrder.indexOf(b[0].toUpperCase()));
                const otherSectorEntries = allSectorEntries.filter(([sectorName]) => !topSectorsOrder.includes(sectorName.toUpperCase())).sort((a, b) => a[0].localeCompare(b[0]));
                const renderSector = (sectorName, employees, isLeader = false) => `<div class="sector-card ${isLeader ? 'leader' : ''}"><h4>${sectorName}</h4><div class="space-y-2">${employees.map(emp => `<div class="employee-card bg-gray-50 rounded shadow-sm p-3 text-center ${isAdminLoggedIn ? 'cursor-pointer' : ''} ${emp.status === 'terminated' ? 'terminated' : ''}" data-factory-id="${factoryId}" data-context-id="" data-sector-name="${sectorName}" data-employee-id="${emp.id}">${emp.name}</div>`).join('')}</div></div>`;
                const topSectorsHtml = topSectorEntries.length > 0 ? `<div class="grid grid-cols-1 sm:grid-cols-2 gap-6 mb-8">${topSectorEntries.map(([name, emps]) => renderSector(name, emps, true)).join('')}</div><hr class="my-8"/>` : '';
                const otherSectorsHtml = otherSectorEntries.length > 0 ? `<h3 class="text-2xl font-bold text-gray-700 mb-6 text-center">Setores de Produção</h3><div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">${otherSectorEntries.map(([name, emps]) => renderSector(name, emps)).join('')}</div>` : '';
                container.innerHTML = `<div class="printable-area"><div class="flex flex-wrap justify-between items-center gap-4 mb-4 no-print"><h2 class="text-3xl font-bold text-gray-800">Organograma Estruturado</h2><div class="flex items-center gap-2">${adminAddButton}<button data-action="print-page" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md transition">Imprimir</button></div></div><div class="w-full max-w-6xl mx-auto"><div class="text-center mb-8 print-header hidden"><svg viewBox="0 0 200 50" class="print-logo" fill="black"><text x="10" y="40" font-family="Inter, sans-serif" font-size="35" font-weight="bold">FABRECK</text></svg><h2 class="print-title">${factory.name.toUpperCase().replace('ORGANOGRAMA', 'FABRECK')}</h2></div><div class="text-center mb-8 no-print"><p class="text-xl text-gray-600">Total de Funcionários Ativos: ${activeEmployeesCount}</p></div>${topSectorsHtml}${otherSectorsHtml}</div></div>`;
            }

            function renderHiringNeedsOverview(container) {
                const content = hiringNeeds.length > 0 ? `<div class="space-y-6">${hiringNeeds.map(need => { const factory = factories[need.factoryId]; let contextLine = `<p class="text-sm text-gray-600">Fábrica: ${factory ? factory.name : 'N/A'}</p>`; if (need.shiftId && factory?.shifts) { const shift = factory.shifts.find(s => s.id === need.shiftId); contextLine += `<p class="text-sm text-gray-600">Turno: ${shift ? shift.name : 'N/A'}</p>`; } return `<div class="bg-yellow-50 border-l-4 border-yellow-500 rounded-r-lg p-4 shadow-md text-left"><div class="flex justify-between items-start"><div><h3 class="text-xl font-bold text-yellow-800">${need.sector}</h3>${contextLine}</div><div class="text-right"><p class="font-semibold">${need.reasonType}</p><p class="text-sm text-gray-600">Início: ${need.expectedStartDate || 'N/A'}</p></div></div>${need.reasonType === 'Desligamento de Funcionário' ? `<p class="text-sm mt-2"><strong>Substituindo:</strong> ${need.employeeToReplace} (Desligamento em: ${need.departureDate || 'N/A'})</p>` : ''}<div class="mt-4 pt-3 border-t"><p class="font-semibold">Responsabilidades:</p><p class="text-sm text-gray-700 whitespace-pre-wrap">${need.keyResponsibilities || 'Não especificado'}</p></div>${need.notes ? `<div class="mt-2 pt-2 border-t"><p class="font-semibold">Observações:</p><p class="text-sm text-gray-700 whitespace-pre-wrap">${need.notes}</p></div>` : ''}</div>` }).join('')}</div>` : `<p class="text-center text-gray-500 text-lg">Nenhuma necessidade de contratação registrada.</p>`;
                container.innerHTML = `<div class="w-full max-w-4xl bg-white rounded-xl shadow-2xl p-6 sm:p-8 lg:p-10 mx-auto"><div class="flex justify-between items-center mb-8"><h2 class="text-3xl font-bold text-gray-800">Necessidades de Contratação</h2><button data-action="add-hiring-need" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md transition ${!isAdminLoggedIn ? 'hidden' : ''}">Adicionar Nova</button></div>${content}</div>`;
            }

            function renderLogView(container) {
                const sortedLog = [...log].sort((a, b) => new Date(b.date.split('/').reverse().join('-')) - new Date(a.date.split('/').reverse().join('-')));
                const content = sortedLog.length > 0 ? `<div class="overflow-x-auto"><table class="min-w-full bg-white rounded-lg shadow"><thead class="bg-gray-200"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Funcionário</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Local</th></tr></thead><tbody class="divide-y divide-gray-200">${sortedLog.map(entry => `<tr><td class="px-6 py-4 whitespace-nowrap">${entry.date}</td><td class="px-6 py-4 whitespace-nowrap"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${entry.type === 'ENTRADA' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${entry.type}</span></td><td class="px-6 py-4 whitespace-nowrap font-medium">${entry.employeeName}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${entry.context}</td></tr>`).join('')}</tbody></table></div>` : `<p class="text-center text-gray-500 text-lg">Nenhum registro de movimentação encontrado.</p>`;
                container.innerHTML = `<div class="w-full max-w-4xl bg-white rounded-xl shadow-2xl p-6 sm:p-8 lg:p-10 mx-auto"><h2 class="text-3xl font-bold text-gray-800 mb-8 text-center">Log de Movimentações</h2>${content}</div>`;
            }
            
            window.addEventListener('DOMContentLoaded', init);
        })();
    </script>

</body>
</html>

